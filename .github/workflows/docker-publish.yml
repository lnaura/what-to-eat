# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Docker Image CI/CD for What-To-Eat

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´: main ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí–ˆì„ ë•Œ
on:
  push:
    branches: [ "main" ]

# ì‹¤í–‰ë  ì‘ì—…(Job)ë“¤ ì •ì˜
jobs:
  build-and-push:
    # ì‘ì—…ì´ ì‹¤í–‰ë  í™˜ê²½
    runs-on: ubuntu-latest

    # ì‘ì—…ì˜ ë‹¨ê³„(Step)ë“¤
    steps:
      # 1. ë ˆĞ¿Ğ¾Ğ·Ğ¸í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Docker Hub ë¡œê·¸ì¸
      # ì €ì¥í•´ ë‘” Secretsë¥¼ ì‚¬ìš©í•˜ì—¬ ë¡œê·¸ì¸í•©ë‹ˆë‹¤.
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Docker ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì„¤ì • (íƒœê·¸ ë“±)
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/what-to-eat-client
            ${{ secrets.DOCKERHUB_USERNAME }}/what-to-eat-server

      # 4. ë°±ì—”ë“œ(ì„œë²„) Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Server Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: true
          # íƒœê·¸ ì˜ˆì‹œ: your-username/what-to-eat-server:latest
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/what-to-eat-server:latest
          labels: ${{ steps.meta.outputs.labels }}

      # 5. í”„ë¡ íŠ¸ì—”ë“œ(í´ë¼ì´ì–¸íŠ¸) Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Client Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: true
          # íƒœê·¸ ì˜ˆì‹œ: your-username/what-to-eat-client:latest
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/what-to-eat-client:latest
          labels: ${{ steps.meta.outputs.labels }}
  # ğŸ‘‡ 2. ì¿ ë²„ë„¤í‹°ìŠ¤ ë°°í¬ ì‘ì—… (ìƒˆë¡œ ì¶”ê°€)
  deploy-to-k8s:
    # 'build-and-push' ì‘ì—…ì´ ì„±ê³µí•´ì•¼ë§Œ ì´ ì‘ì—…ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Kubernetes Cluster
        # SSH ì›ê²© ì ‘ì†ì„ ë„ì™€ì£¼ëŠ” ì•¡ì…˜
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_PORT }}
          # VMì— ì ‘ì†í•´ì„œ ì‹¤í–‰í•  ëª…ë ¹ì–´ë“¤
          script: |
            # 1. ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            kubectl apply -f project/backend.yaml
            kubectl apply -f project/frontend.yaml

            # 2. (ë§¤ìš° ì¤‘ìš”) Deploymentë¥¼ ì¬ì‹œì‘í•˜ì—¬ Docker Hubì—ì„œ ìƒˆ ì´ë¯¸ì§€ë¥¼ ê°•ì œë¡œ ë°›ì•„ì˜¤ê²Œ í•©ë‹ˆë‹¤.
            #    image íƒœê·¸ê°€ :latestë¡œ ë™ì¼í•´ë„ ì´ ëª…ë ¹ì–´ë¡œ íŒŒë“œë¥¼ ìƒˆë¡œ ë„ì›Œì•¼ ë³€ê²½ì‚¬í•­ì´ ë°˜ì˜ë©ë‹ˆë‹¤.
            kubectl rollout restart deployment what-to-eat-server-deployment
            kubectl rollout restart deployment what-to-eat-client-deployment